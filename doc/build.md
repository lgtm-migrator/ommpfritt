# Building ommpfritt

## Overview

*omm* uses the [cmake](cmake.org) build system generator.
The sources contain

-    implementation (`*.cpp`), header (`*.h`) and interface files (`*.ui`).
-    configuration files (`*.cfg`)
-    translation files (`*.ts`)
-    resource files (`*.qrc`)
-    list files (`*.lst`)
-    cmake files (`CMakeLists.txt`)

Some additional implementation, header and resource files will be generated during the
build process.

## Build environment

*omm* is known to successfully compile and run on Arch Linux, Ubuntu Linux and
Windows/MSYS2.
Neither building nor running on Mac has ever been tested, but it should work in theory!
We recommend using **g++9.x** or later. g++7.x or earlier will not work.
Building with a recent **clang** is possible (tested with 8.0.0).
A very recent Visual Studio might work, (partial) C++20 support is required.
**cmake 3.14** or later is required.

## Build from scratch

Once you've installed the dependencies, it's very straight forward to build omm
using the common CMake build workflow.
Detailed informations about the dependencies, how to get them and how to run
the build commands on various platforms can be obtained from the workflow files in the
`.github/workflows` directory.

## Details

The following targets exist:

-   `ommpfritt`: the main target, this builds the executable that shows the GUI.
-   `ommpfritt-cli`: A version that behaves as you expect on the Windows command line. Does not exist on linux, use `ommpfritt -platform offscreen` there instead.
-   `icons` Generates the icons. Requires `ommpfritt` to be installed.
-   `update-ts` Updates the `*.ts` files, such that you can edit them with the `linguist`. Only requires a configured build directory.

The `icon` target and the `updates-ts` target need to be invoked manually.

### Build Ommpfritt including Icons

Many of the icons that are present in the *omm* graphical user interface are generated by *omm* itself.
Hence, you first need a runnable *omm* installation without icons.
Then, you use this installation to generate the icons and eventually you add the icons into the installation.

That may sound complicated, but a CMake target exists for every step, which simplifies and speeds up the processes a lot:

1.  Configure the build: `cmake -S SOURCE_DIRECTORY -B BUILD_DIRECTORY ADDITIONAL_OPTIONS`
2.  Build and install: `cmake --build BUILD_DIRECTORY --target install`
3.  Generate the icons: `cmake --build BUILD_DIRECTORY --target icons`
4.  Configure again to make the build system aware: `cmake -S SOURCE_DIRECTORY -B BUILD_DIRECTORY`
5.  Build with icons (and optionally install) `cmake --build BUILD_DIRECTORY`

`SOURCE_DIRECTORY` here is the root of the repository.

Step *3.* may take some time and CMake won't display the output until it's done, so it looks like the process froze.
If you want more direct feedback, you can generate the icons manually by calling `BUILD_DIRECTORY/generate-icons.py` (without any parameters).
It will do exactly the same in the same time, but with more direct feedback.

The `icon` target could be declared as a dependency and be part of the automatic build process, and this was the case in earlier releases.
However, `icons` depends on almost anything and its execution takes a significant amount of time.
That made the development-test-cycle extraordinary cumbersome and hence the `icons` target is now separate.

### Updating Translation

You only need to read this if you want to update a translation file.
Some files required for the build are generated during the build using non-standard methods to avoid redundancy.
That means, that you need to configure the build and to invoke `lupdate` via a CMake target, if you want to have a complete set of translatable strings.

1.  Configure the build: `cmake -S SOURCE_DIRECTORY -B BUILD_DIRECTORY`
2.  Update the `*.ts` files: `cmake --build BUILD_DIRECTORY --target update-ts`
3.  Run the `linguist`: `linguist SOURCE_DIRECTORY/ts/omm_de.ts`
4.  Build normally to see the result.
